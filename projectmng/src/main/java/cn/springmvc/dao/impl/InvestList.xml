<?xml version = "1.0" encoding = "UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">     
<mapper namespace = "investList">  
   <resultMap type = "cn.springmvc.model.ProjectAppRecordEntity" id = "resultListProjectAppRecord">
        <id property = "applyId"						column = "Apply_Id" />
		<result property = "memberID"       	column = "Member_ID" />
		<result property = "projectType"    	column = "Project_Type" />
		<result property = "projectBaseID"  	column = "Project_Base_ID" />
		<result property = "projectBaseID"  	column = "Project_Base_ID" />
		<result property = "repayGuarantee" 	column = "Repay_Guarantee" />
		<result property = "guarantyDescribe"   column = "Guaranty_Describe" />
		<result property = "minStart" 			column = "MinStart" />
		<result property = "increaseRange" 		column = "Increase_Range" />
		<result property = "investMax" 			column = "Invest_Max" />
		<result property = "checkStatu" 		column = "Check_Statu" />
		<result property = "publishStatu" 		column = "Publish_Statu" />  
		<result property = "investStatu" 		column = "Invest_Statu" />
		<result property = "isDirect" 			column = "Is_Direct" />
		<result property = "directPwd"		    column = "Direct_Pwd" />  
        <result property = "assetManagerID" 	column = "Asset_Manager_ID" />
		<result property = "guaranteeID" 		column = "Guarantee_ID" />
		<result property = "rateAddRate" 		column = "Rate_Add_Rate" /> 
		<result property = "rewardRate" 		column = "Reward_Rate" />
		<result property = "rewardIcon" 		column = "Reward_Icon" /> 
		<result property = "investCountMax" 	column = "Invest_Count_Max" />
		<result property = "projectNo" 			column = "Project_No" /> 
      	<result property = "merBillNo" 			column = "Mer_BillNo" /> 
        <result property = "investRate" 		column = "Invest_Rate" /> 
        <result property = "imageUrl" 		    column = "Image_Url" /> 
        <result property = "availableaAmount"   column = "availableaAmount" /> 
      <association property="projectBaseInfoentity" column="id"> 
	        <id property = "ID" 				 column = "id" />
			<result property = "projectTitle"    column = "Project_Title" /> 
			<result property = "uses"            column = "Uses" />
			<result property = "repaySource"     column = "Repay_Source" />
			<result property = "amount" 		 column = "Amount" />
			<result property = "projectDescript" column = "Project_Descript" />
			<result property = "deadline" 		 column = "Deadline" />
			<result property = "deadlineType"    column = "Deadline_Type" />
			<result property = "repayWay"        column = "Repay_Way" />
			<result property = "yearRate"        column = "Year_Rate" /> 
			<result property = "startDate"       column = "Start_Date" /> 
			<result property = "endDate"         column = "End_Date" /> 
		</association>
    </resultMap> 
    <!-- 分页查询投资项目列表 -->  
	<select id = "selectInvestListfront" parameterType = "product_p2p.kit.pageselect.PageEntity"  resultMap = "resultListProjectAppRecord">
	   select par.Apply_Id,par.Project_ID,par.Project_Base_ID,pbi.Project_Title,par.Project_No,pbi.Repay_Way,
	    pbi.Year_Rate,pbi.Amount,pbi.Deadline,pbi.Deadline_Type, pap.Start_Date,pap.End_Date,par.Invest_Statu,
	    pim.Image_Url,
       (pbi.Amount-(select ifnull(sum(CAST((AES_DECRYPT(UNHEX(Invest_Amount_Valid),#{map.sKey})) as signed)),0)  
       from Invest_Record  where Apply_Id=par.Apply_Id and IsValid=0)) availableaAmount
       
	   from Project_App_Record par 
	   left join Project_App_Process pap  on  pap.Apply_Id=par.Apply_Id
	   left join Project_Base_Info pbi on  par.Project_Base_ID=pbi.Project_Base_ID
	   left join ProjectBaseInfo pty on  par.Project_ID=pty.Project_ID 
	   left join Project_Image pim on pim.Apply_Id =  par.Apply_Id
           <where>  
                 <!-- 项目编号或名称--> 
	            <if test = "map.projectinfo != null">  
	             ( pbi.Project_Title   like '%${map.projectinfo}%' or par.Project_No  like '%${map.projectinfo}%' ) 
	            </if> 
                <!-- 项目状态 -->
	            <if test = "map.investStatu !=  -1">  
	                and  par.Invest_Statu = #{map.investStatu} 
	            </if> 
	            <!-- 还款方式-->  
	            <if test = "map.repayWay !=  -1">  
	                and pbi.Repay_Way = #{map.repayWay}
	            </if>
                 <!-- 加息标 -->
	            <if test = "map.reward !=  -1 and map.reward = 1">  
	                and par.Rate_Add_Rate = #{map.rateAddRate}
	            </if>
	             <!-- 返现 -->
	            <if test = "map.reward !=  -1 and map.reward = 2">  
	                and par.Reward_Icon = #{map.rewardIcon}
	            </if> 
	              <!-- 无奖励 -->
	             <if test = "map.reward !=  -1 and map.reward = 3">  
	                and par.Reward_Icon =0 and  par.Rate_Add_Rate=0
	            </if>  
	             <!-- 借款类型-->  
	            <if test = "map.projectType !=  -1">  
	                and par.Project_Base_ID = #{map.projectType}
	            </if> 
	            <!-- 年化利率-->  
	            <if test = "map.yearratemin !=  -1">  
	                and pbi.Year_Rate > #{map.yearratemin}
	            </if> 
	            <!-- 年化利率-->  
	            <if test = "map.yearratemax !=  -1">  
	                and #{map.yearratemax} > pbi.Year_Rate  
	            </if>     
	            <!-- 借款期限  天标-->  
	            <if test = "map.deadlineType  = 0  and map.deadlinemin != 0">  
	                and pbi.Deadline > #{map.deadlinemin}  and pbi.Deadline_Type=0
	            </if>
	            <!-- 借款期限  天标-->  
	            <if test = "map.deadlineType  = 0  and map.deadlinemax != 0">  
	                and #{map.deadlinemin}>pbi.Deadline     and pbi.Deadline_Type=0
	            </if> 
	             <!-- 借款期限  月标-->  
	            <if test = "map.deadlineType  = 1 and map.deadlinemin != 0">  
	                and pbi.Deadline > #{map.deadlinemin}  and pbi.Deadline_Type=1
	            </if> 
	              <!-- 借款期限  月标-->  
	            <if test = "map.deadlineType  = 1  and map.deadlinemax != 0">  
	                and #{map.deadlinemin}>pbi.Deadline     and pbi.Deadline_Type=1
	            </if> 
	             <!-- 借款期限  年标-->  
	            <if test = "map.deadlineType  = 2 and map.deadlinemin != 0">  
	                and pbi.Deadline >= #{map.deadlinemin}  and pbi.Deadline_Type=2
	            </if> 
	              <!-- 借款期限  年标-->  
	            <if test = "map.deadlineType  = 2  and map.deadlinemax != 0">  
	                and #{map.deadlinemax}>=pbi.Deadline     and pbi.Deadline_Type=2
	            </if> 
	                and  par.Invest_Statu >=0 
	          </where>
    </select>
</mapper>   